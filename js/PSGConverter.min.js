/*!
 * PSGConverter.js
 * v1.3
 * Copyright (c)2007-2013 Logue <http://logue.be/> All rights reserved.
 * Lisence: GPL v2
 */
(function(g,F,G){function B(a){for(var m=[["P",200,100,0],["F",400,200,100],["E",500,200,100],["D",600,250,150],["C",650,250,200],["B",700,300,200],["A",750,300,200],["9",800,350,200],["8",850,400,200],["7",900,400,200],["6",950,450,200],["5",1E3,500,250],["4",1050,550,300],["3",1100,600,350],["2",1150,700,400],["1",1200,800,500]],d=0;d<m.length;d++){var c=m[d];"undefined"==typeof a[0]&&(a[0]="");"undefined"==typeof a[1]&&(a[1]="");"undefined"==typeof a[2]&&(a[2]="");if(c[1]>=a[0].length&&c[2]>=a[1].length&&
c[3]>=a[2].length)return'<span title="'+h("Melody")+": "+a[0].length+" / "+h("Chord1")+": "+a[1].length+" / "+h("Chord2")+": "+a[2].length+'">'+h("Rank")+": "+c[0]+"</span>"}return"-"}function u(a,m,d,c,e,f,b,g,h){var n=f==b?!0:!1,k=w,q=4,j=8,s=0,l=!1,t=x,n=!1;f==b&&(m=9,n=!0);var p=[];0==g&&(p.push({time:0,msg:String.fromCharCode(255,88,4,4,2,24,8)}),p.push({time:0,msg:String.fromCharCode(255,81,3)+z(5E5,3)}),p.push({time:0,msg:String.fromCharCode(255,84,5,w,0,0,0,0)}),p.push({time:0,msg:H}));p.push({time:0,
msg:String.fromCharCode(255,3,h.length)+h});p.push({time:96,msg:String.fromCharCode(192+m,d)});p.push({time:192,msg:String.fromCharCode(176+m,10,c)});p.push({time:288,msg:String.fromCharCode(176+m,91,e)});a=a.match(/[A-GLNORTV<>][\+\#-]?[0-9]*\.?&?/ig);for(d=0;d<a.length;d++){if(a[d].match(/([LOTV<>])([1-9][0-9]*|0?)(\.?)(&?)/i))switch(1==l&&"&"!=RegExp.$4&&(l=0,p.push({time:t,msg:String.fromCharCode(128+m,s,v)})),RegExp.$1){case "L":case "l":1<=RegExp.$2&&RegExp.$2<=v&&(k=Math.floor(x/RegExp.$2),
"."==RegExp.$3&&(k=Math.floor(1.5*k)));break;case "O":case "o":1<=RegExp.$2&&8>=RegExp.$2&&(q=parseInt(RegExp.$2));break;case "T":case "t":32<=RegExp.$2&&255>=RegExp.$2&&p.push({time:t,msg:String.fromCharCode(255,81,3)+z(Math.floor(6E7/RegExp.$2),3)});break;case "V":case "v":""!=RegExp.$2&&(0<=RegExp.$2&&15>=RegExp.$2)&&(j=parseInt(RegExp.$2));break;case "<":q=1>=q?1:q-1;break;case ">":q=8<=q?8:q+1}if(a[d].match(/([A-GN])([\+\#-]?)([0-9]*)(\.?)(&?)/i)){c=k;e=RegExp.$3;switch(RegExp.$1){case "n":case "N":12<=
e&&95>=e&&(r=e);break;default:if(1<=e&&e<=v&&(c=Math.floor(x/e)),"."==RegExp.$4&&(c=Math.floor(1.5*c)),!n){var r=12*q+I[RegExp.$1.toLowerCase()];switch(RegExp.$2){case "+":case "#":r++;break;case "-":r--}}}if(n)r=b;else{for(;r<f;)r+=12;for(;r>b;)r-=12;r+=12}!0==l&&r!=s&&(l=!1,p.push({time:t,msg:String.fromCharCode(128+m,s,8*j)}));!1==l&&p.push({time:t,msg:String.fromCharCode(144+m,r,8*j)});t+=c;"&"==RegExp.$5?(l=!0,s=r):(l=!1,p.push({time:t,msg:String.fromCharCode(128+m,r,8*j)}))}else!0==l&&(l=!1,
p.push({time:t,msg:String.fromCharCode(128+m,s,8*j)}));a[d].match(/[rR]([0-9]*)(\.?)/)&&(c=k,e=RegExp.$1,1<=e&&e<=v&&(c=Math.floor(x/e)),"."==RegExp.$2&&(c=Math.floor(1.5*c)),t+=c)}p.push({time:t+v,msg:String.fromCharCode(255,47,0)});f="";var u;for(m=0;m<p.length;m++){b=p[m].time-u;u=p[m].time;b=parseInt(b);n=String.fromCharCode(b&127);for(b>>>=7;0<b;)n=String.fromCharCode(128+(b&127))+n,b>>>=7;f+=n+p[m].msg}return J+z(f.length,4)+f}function C(a,g){var d=16,c=88,e=0,f="";if(a.mml){if(a.min||a.max)d=
a.min,c=a.max;var b=a.inst&&0<=a.inst&&128>a.inst?Math.round(a.inst):0,h=a.pan&&0<=a.pan&&128>a.pan?Math.round(a.pan):64,l=a.effect&&0<=a.effect&&128>a.effect?Math.round(a.effect):40;if(d==c){for(var n="",k=0;k<a.mml.length;k++)n+=a.mml[k];f+=u(n,9,b,h,l,d,c,e,a.inst_name,!0)}else for(k=0;k<a.mml.length;k++)f+=u(a.mml[k],0,b,h,l,d,c,e,a.inst_name,0==k?!0:!1),e++}else if("object"===typeof a)for(var q=0;q<a.length;q++){var j=a[q];if(j.min||j.max)d=j.min,c=j.max;b=j.inst&&0<=j.inst&&128>j.inst?Math.round(j.inst):
0;h=j.pan&&0<=j.pan&&128>j.pan?Math.round(j.pan):64;l=j.effect&&0<=j.effect&&128>j.effect?Math.round(j.effect):40;if(d==c){n="";for(k=0;k<j.mml.length;k++)n+=j.mml[k];f+=u(n,9,b,h,l,d,c,e,j.inst_name,!0)}else for(k=0;k<j.mml.length;k++)f+=u(j.mml[k],q,b,h,l,d,c,e,j.inst_name,0==k?!0:!1),e++}var d=String.fromCharCode(77,84,104,100,0,0,0,6,0,1,0,e,0,w)+f,s;if(g){try{s=btoa(d)}catch(v){s="";c=-6;for(b=f=e=0;f<d.length||-6<c;)0>c&&(f<d.length?(h=d.charCodeAt(f++),b+=8):h=0,e=(e&255)<<8|h&255,c+=8),s+=
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(0<b?e>>c&63:64),c-=6,b-=6}s="data:audio/midi;base64,"+s}else s=d;return s}function D(a,g){return['<object type="audio/midi" width="1" height="1"'+(g?'data-group="'+g+'" ':""),(y?'classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" codebase="http://www.apple.com/qtactivex/qtplugin.cab"':'data="'+a+'"')+">",'<param name="controller" value="false" />','<param name="src" value="'+a+'" />','<param name="autoplay" value="false" />\n<param name="pluginspage" value="http://www.apple.com/quicktime/download/" />\n</object>'].join("\n")}
var y=!1,E=(navigator.userLanguage||navigator.browserLanguage||navigator.language).substr(0,2),l={Lute:{inst:24,max:88,min:16,mms:0},Ukulele:{inst:28,max:88,min:16,mms:1},Mandorin:{inst:105,max:88,min:16,mms:2},Whistle:{inst:72,max:88,min:60,mms:3},Flute:{inst:73,max:83,min:48,mms:4},Roncadora:{inst:77,max:83,min:48,mms:5},Chalumeau:{inst:71,max:59,min:24,mms:6},Tuba:{inst:58,max:59,min:24,mms:30},Lyre:{inst:46,max:88,min:16,mms:0},Snare:{inst:48,max:38,min:38,mms:0},Drum:{inst:48,max:40,min:40,mms:20},
"Bass Drum":{inst:48,max:35,min:35,mms:19},Cymbal:{inst:48,max:57,min:57,mms:21},Xylophone:{inst:15,max:88,min:16,mms:0},"E.Guitar":{inst:30,max:88,min:16,mms:0}},A={en:{Rank:"Rank",Inst:"Instrument",Melody:"Melody",Chord1:"Chord 1",Chord2:"Chord 2",rewind:"Rewind",play:"Play",pause:"Pause",copy:"Copy",e_rewind:"Rewind (Ensemble)",e_play:"Play (Ensemble)",e_pause:"Pause (Ensemble)","export":"Export",msg_copied:"Copied MML to clipboard.",Lute:"Lute",Ukulele:"Ukulele",Mandorin:"Mandorin",Whistle:"Whistle",
Flute:"Flute",Roncadora:"Roncadora",Chalumeau:"Chalumeau",Tuba:"Tuba",Lyre:"Lyre",Snare:"Snare",Drum:"Drum","Bass Drum":"Bass Drum",Cymbal:"Cymbal",Xylophone:"Xylophone","E.Guitar":"Electric Guitar"},ja:{Rank:"\u30e9\u30f3\u30af",Inst:"\u697d\u5668",Melody:"\u30e1\u30ed\u30c7\u30a3",Chord1:"\u548c\u97f3\uff11",Chord2:"\u548c\u97f3\uff12",rewind:"\u5dfb\u304d\u623b\u3057",play:"\u518d\u751f",pause:"\u4e00\u6642\u505c\u6b62",copy:"\u30b3\u30d4\u30fc",e_rewind:"\u5dfb\u304d\u623b\u3057\uff08\u5408\u594f\uff09",
e_play:"\u518d\u751f\uff08\u5408\u594f\uff09",e_pause:"\u4e00\u6642\u505c\u6b62\uff08\u5408\u594f\uff09","export":"\u30a8\u30af\u30b9\u30dd\u30fc\u30c8",msg_copied:"\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f\u3002",Lute:"\u30ea\u30e5\u30fc\u30c8",Ukulele:"\u30a6\u30af\u30ec\u30ec",Mandorin:"\u30de\u30f3\u30c9\u30ea\u30f3",Whistle:"\u30db\u30a4\u30c3\u30b9\u30eb",Flute:"\u30d5\u30eb\u30fc\u30c8",Roncadora:"\u30ed\u30f3\u30ab\u30c9\u30fc\u30e9",Chalumeau:"\u30b7\u30e3\u30ea\u30e5\u30e2\u30fc",
Tuba:"\u30c1\u30e5\u30fc\u30d0",Lyre:"\u30ea\u30e9",Snare:"\u30b9\u30cd\u30a2",Drum:"\u5c0f\u592a\u9f13","Bass Drum":"\u5927\u592a\u9f13",Cymbal:"\u30b7\u30f3\u30d0\u30eb",Xylophone:"\u30b7\u30ed\u30d5\u30a9\u30f3","E.Guiter":"\u30a8\u30ec\u30ad\u30ae\u30bf\u30fc"},ko:{Rank:"\uc21c\uc704",Inst:"\uc545\uae30",Melody:"\uba5c\ub85c\ub514",Chord1:"\ud654\uc74c 1",Chord2:"\ud654\uc74c 2",rewind:"\ub418\uac10\uae30",play:"\uc7ac\uc0dd",pause:"\uc77c\uc2dc \uc815\uc9c0",copy:"\ubcf5\uc0ac",e_rewind:"\ub418\uac10\uae30 (\ud569\uc8fc)",
e_play:"\uc7ac\uc0dd (\ud569\uc8fc)",e_pause:"\uc77c\uc2dc \uc815\uc9c0 (\ud569\uc8fc)","export":"\ub0b4\ubcf4\ub0b4\uae30",msg_copied:"\ud074\ub9bd \ubcf4\ub4dc\uc5d0 \ubcf5\uc0ac\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",Lute:"\ub958\ud2b8",Ukulele:"\uc6b0\ucfe8\ub810\ub808",Mandorin:"\ub9cc\ub3cc\ub9b0",Whistle:"\ud718\uc2ac",Flute:"\ud50c\ub8e8\ud2b8",Roncadora:"\ub860\uce74\ub3c4\ub77c",Chalumeau:"\uc0ec\ub8e8\ubaa8",Tuba:"\ud53c\uc2dc\uc2a4 \ud29c\ubc14",Lyre:"\ub9ac\ub77c",Snare:"\uc2a4\ub124\uc5b4 \ub4dc\ub7fc",
Drum:"\uc791\uc740 \ubd81","Bass Drum":"\ud070 \ubd81",Cymbal:"\uc2ec\ubc8c\uc988",Xylophone:"\uc2e4\ub85c\ud3f0","E.Guiter":"\uc77c\ub809\ud2b8\ub9ad \uae30\ud0c0"},zh:{Rank:"\u7b49\u7ea7",Inst:"\u4eea\u5668",Melody:"\u65cb\u5f8b",Chord1:"\u548c\u5f26 1",Chord2:"\u548c\u5f26 2",rewind:"\u56de\u5377",play:"\u64ad\u653e",pause:"\u6682\u505c",copy:"\u590d\u5236",e_rewind:"\u56de\u5377 (\u5408\u594f)",e_play:"\u64ad\u653e (\u5408\u594f)",e_pause:"\u6682\u505c (\u5408\u594f)","export":"\u8f93\u51fa",
msg_copied:"\u590d\u5236\u7684MML\u5230\u526a\u8d34\u677f\u3002",Lute:"\u9c81\u7279\u7434",Ukulele:"\u590f\u5a01\u5937\u56db\u5f26\u7434",Mandorin:"\u66fc\u9640\u6797",Whistle:"\u77ed\u7b1b",Flute:"\u957f\u7b1b",Roncadora:"\u54c6\u5566",Chalumeau:"\u5355\u7c27\u7ba1",Tuba:"\u5927\u865f",Lyre:"\u4e03\u5f26\u7434",Snare:"\u519b\u9f13",Drum:"\u5c0f\u9f13","Bass Drum":"\u4f4e\u97f3\u9f13",Cymbal:"\u94b9",Xylophone:"\u6728\u7434","E.Guiter":"\u7535\u5409\u4ed6"}},h=function(a){return"undefined"==typeof A[E][a]?
A.en[a]:A[E][a]},w=96,x=4*w,v=2*w,J=String.fromCharCode(77,84,114,107);String.fromCharCode(255,47);var I={c:0,d:2,e:4,f:5,g:7,a:9,b:11},H=String.fromCharCode(240,5,126,127,9,1,247),z=function(a,g){for(var d=parseInt(a),c="",e=0;e<g;e++)c=String.fromCharCode(d&255)+c,d>>>=8;return c};g(G).ready(function(){var a=0,m={};g("head").append('<link rel="stylesheet" href="http://logue.github.com/PSGConverter/css/PSGConverter.min.css" />');y&&g.getScript("http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js",
function(){CFInstall.check({mode:"overlay"})});g(".mabimml").each(function(){var e=g(this),f=e.data(),b={},c;c=e.contents()[0].nodeValue.replace(/\r\n|\n\r|\n|\r|\s|/g,"").match(/MML\@([0-9A-GLNORTV#<>.&+-]*),([0-9A-GLNORTV#<>.&+-]*),([0-9A-GLNORTV#<>.&+-]*);/i);"object"!==typeof c?c=!1:c.shift();if(!1===c)e.before('<p class="alert alert-error">Could not parse MML. Invalied format?</p>');else{if(""!==f.instName&&l[f.instName])b={inst_name:f.instName,inst:l[f.instName].inst,max:l[f.instName].max,min:l[f.instName].min};
else if(""!==f.inst)for(var d in l)if(l[d].inst=f.inst){b={inst_name:d,inst:l[d].inst,max:l[d].max,min:l[d].min};break}b.group=f.group?f.group:0;b.debug=f.debug?!0:!1;b.pan=f.pan?f.pan:64;b.effect=f.effect?f.effect:40;b.mml=c;b.id=a;f=!y?C(b,!0):"http://comp.mabinogi.jp/PSGConverter.exe? /i"+b.inst+" "+encodeURIComponent(b.mml[0]+","+b.mml[1]+","+b.mml[2]);d=e.attr("title")?"fieldset":"div";e.wrapAll(["<"+d+' class="mml-player" '+(0!==b.group?'data-group="'+b.group+'" ':"")+">",e.attr("title")?"<legend>"+
e.attr("title")+' <span class="label">'+B(c)+'</span>  <span class="label label-info">'+h("Inst")+": "+h(b.inst_name)+"</span></legend>":'<span class="label">'+B(c)+'</span>  <span class="label label-info">'+h("Inst")+": "+h(b.inst_name)+"</span>",b.debug?'<a class="mml-debug btn btn-mini btn-warning" href="'+f+'">debug.mid</a>':"",'<button class="mml-rewind btn btn-mini">'+h("rewind")+"</button>",'<button class="mml-play btn btn-mini btn-primary">'+h("play")+"</button>",'<button class="mml-pause btn btn-mini btn-danger" style="display:none;">'+
h("pause")+"</button>",'<button class="mml-copy btn btn-mini btn-info" data-str="'+("MML@"+b.mml[0]+","+b.mml[1]+","+b.mml[2]+";")+'">'+h("copy")+"</button>",D(f),"</"+d+">"].join("\n"));var e=e.parent(),n=e.children("object")[0],k=e.children(".mml-play"),q=e.children(".mml-pause");e.children(".mml-rewind",this).click(function(){n.Rewind()});k.click(function(){console.log(n);n.Play();k.css({display:"none"});q.css({display:"inline-block"})});q.click(function(){n.Stop();q.css({display:"none"});k.css({display:"inline-block"})});
if(b.group)try{m[b.group].push(b)}catch(j){m[b.group]=[],m[b.group].push(b)}}a++});g(".mabimml-insts").each(function(){for(var a in l)g(this).append('<option value="'+a+'">'+h(a)+"</option>")});if(!y)for(var d in m){var c=C(m[d],!0);g("body").append(D(c,d));g(".mml-player[data-group="+d+"]").each(function(){g(".mml-pause",this).after(m.debug?'<a class="mml-ensumble-debug btn btn-mini btn-inverse" href="'+c+'">debug.mid</a>':"",'<button class="mml-ensumble-rewind btn btn-mini">'+h("e_rewind")+'</button><button class="mml-ensumble-play btn btn-mini btn-success">'+
h("e_play")+'</button><button class="mml-ensumble-pause btn btn-mini btn-danger" style="display:none;">'+h("e_pause")+"</button>")});g(".mml-ensumble-rewind").click(function(){var a=g(this).parent().data().group;g("object[data-group="+a+"]")[0].Rewind()});g(".mml-ensumble-play").click(function(){var a=g(this).parent().data().group;g("object[data-group="+g(this).parent().data().group+"]")[0].Play();g("*[data-group="+a+"] .mml-ensumble-play").css({display:"none"});g("*[data-group="+a+"] .mml-ensumble-pause").css({display:"inline-block"})});
g(".mml-ensumble-pause").click(function(){var a=g(this).parent().data().group;g("object[data-group="+g(this).parent().data().group+"]")[0].Stop();g("*[data-group="+a+"] .mml-ensumble-pause").css({display:"none"});g("*[data-group="+a+"] .mml-ensumble-play").css({display:"inline-block"})})}"file:"!==location.protocol&&g.getScript("http://logue.github.com/PSGConverter/js/ZeroClipboard/ZeroClipboard.min.js",function(){ZeroClipboard.setMoviePath("http://logue.github.com/PSGConverter/js/ZeroClipboard/ZeroClipboard.swf");
g(".mml-copy").each(function(){var a=new ZeroClipboard.Client;a.setHandCursor(!0);a.glue(this);var c=this;a.addEventListener("onMouseDown",function(){a.setText(g(c).attr("data-str"))});a.addEventListener("complete",function(){alert(h("msg_copied"))})})})});g(F).unload(function(){g("object").each(function(){g(this)[0].Stop()})})})(jQuery,this,this.document);